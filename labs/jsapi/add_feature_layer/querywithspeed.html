<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Query features with speed</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.12/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.12/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #infoDiv {
        background-color: white;
        color: black;
        padding: 6px;
        width: 400px;
      }

      #results {
        font-weight: bolder;
        padding-top: 10px;
      }
      .slider {
        width: 100%;
        height: 60px;
      }
      #drop-downs {
        padding-bottom: 15px;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/geometry/geometryEngine",
        "esri/Graphic",
        "esri/widgets/Slider"
      ], function(
        Map,
        MapView,
        FeatureLayer,
        GraphicsLayer,
        geometryEngine,
        Graphic,
        Slider
      ) {
	    let typeView;
		
	    var providerurl = "https://kadebeem.esri.com/server/rest/services/FCC_Form477SummaryDec2017v2/MapServer/0";
		
		var template = {
          // autocasts as new PopupTemplate()
          title: "Values",
          content: [
            {
              type: "fields",
			  fieldInfos: [
                {
                  fieldName: "MaxUp40",
                  label: "MaxUp40"
                },
                {
                  fieldName: "MaxDown40",
                  label: "MaxDown40",
                  
                },
                {
                  fieldName: "DistinctBBOfferings40",
                  label: "DistinctBBOfferings40",
                },
                {
                  fieldName: "DistinctBBOfferings41",
                  label: "DistinctBBOfferings41",
                  
                }
              ]
            }
          ]
        };
		
		var uploadSpeed=0, downloadSpeed=0, providertype;
		
		const fccRenderer = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: {
            type: "simple-fill", // autocasts as new SimpleMarkerSymbol()
            color: [0, 255, 255, .25],
            outline: {
			  color: [0, 255, 255],
			  width: 0.2
			},
          }
        };
		var providerTypeSelect = document.getElementById("provider-type");
		
		var upSlider = new Slider({
          container: "upspeed",
          min: 0,
          max: 100,
          steps: 1,
          values: [0],
          rangeLabelsVisible: true,
          labelsVisible: true
        });
		
		var downSlider = new Slider({
          container: "downspeed",
          min: 0,
          max: 1000,
          steps: 5,
          values: [0],
          rangeLabelsVisible: true,
          labelsVisible: true
        });
		
		var queryProviders = document.getElementById("query-providers");
		
		// provider data
        var providersLayer = new FeatureLayer({
          url: providerurl,
          outFields: ["*"],
          visible: true,
		  renderer: fccRenderer,
		  popupTemplate: template
        });
		
		var map = new Map({
          basemap: "dark-gray",
          layers: [providersLayer]
        });

        var view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-75.17, 40.00],
          zoom: 13
        });
        view.ui.add("infoDiv", "top-right");

		upSlider.on("thumb-drag", function(event) {
			uploadSpeed = parseInt(event.value, 10);
		});
		downSlider.on("thumb-drag", function(event) {
			downloadSpeed = parseInt(event.value,10);
			console.log(downloadSpeed);
		});
		
		queryProviders.addEventListener("click", function() {
          queryProvidersBtn();
        });
		
		view.whenLayerView(providersLayer).then(function(layerView) {
          // layer loaded
          // get a reference to the type layerview
          typeView = layerView;

          });

		 providerTypeSelect.addEventListener("change", function() {
          providertype = event.target.value;
        });
		
		function queryProvidersBtn() {
		  var selectedType;
		  if (providertype != "none") {
			selectedType = "DistinctBBOfferings" + providertype;
			console.log(selectedType);
		  }
		  else {
			selectedType = "none";
			console.log(selectedType);
		  }
		  if (selectedType == "none") {
		    typeView.filter = null;
		  }
		  else if (selectedType == "DistinctBBOfferings40") {
			var buildquery = selectedType + " <> 0 AND (MaxDown40 >= " + downloadSpeed + " AND MaxUp40 >= " + uploadSpeed + ") OR DistinctBBOfferings41 <> 0 AND (MaxDown41 >= " + downloadSpeed + " AND MaxUp41 >= " + uploadSpeed + ") OR DistinctBBOfferings42 <> 0 AND (MaxDown42 >= " + downloadSpeed + " AND MaxUp42 >= " + uploadSpeed + ") OR DistinctBBOfferings43 <> 0 AND (MaxDown43 >= " + downloadSpeed + " AND MaxUp43 >= " + uploadSpeed + ")";
			console.log(buildquery);
		    typeView.filter = {
				where: buildquery
             };
		  } 
		  else if (selectedType == "DistinctBBOfferings11") {
		  var buildquery = selectedType + " <> 0 AND (MaxDown11 >= " + downloadSpeed + " AND MaxUp11 >= " + uploadSpeed + ") OR DistinctBBOfferings10 <> 0 AND (MaxDown10 >= " + downloadSpeed + " AND MaxUp10 >= " + uploadSpeed + ") OR DistinctBBOfferings20 <> 0 AND (MaxDown20 >= " + downloadSpeed + " AND MaxUp20 >= " + uploadSpeed + ") OR DistinctBBOfferings12 <> 0 AND (MaxDown12 >= " + downloadSpeed + " AND MaxUp12 >= " + uploadSpeed + ")";
			typeView.filter = {
				where: buildquery
             };
		  }
		  else {
			var maxdownfield = "MaxDown" + providertype;
			var maxupfield = "MaxUp" + providertype;
			typeView.filter = {
				where: selectedType + " <> 0 AND (" + maxdownfield + " >= " + downloadSpeed + " AND " + maxupfield + " >= " + uploadSpeed + ")"
			};
		  }
		  
		}
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="infoDiv" class="esri-widget">
      <div id="drop-downs">
        Select provider type:
        <select id="provider-type" class="esri-widget">
		  <option value="none">None</option>
		  <option value="0">All Other</option>
		  <option value="50">Fiber Optic</option>
		  <option value="40">Cable Modem</option>
		  <option value="11">DSL</option>
		  <option value="90">Electric Powerine</option>
		  <option value="70">Fixed Wireless</option>
		  <option value="30">Other Copper</option>
		</select>
	  </div>
      Download Speed (Mbps):
      <div id="downspeed" class="slider"></div>
      Upload Speed (Mbps):
      <div id="upspeed" class="slider"></div>
      <button id="query-providers" class="esri-widget">Query Providers</button>
      <div id="results" class="esri-widget"></div>
    </div>
  </body>
</html>
