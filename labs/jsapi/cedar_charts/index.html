<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Cedar Charts</title>
  <link rel='stylesheet' href='https://js.arcgis.com/3.23/esri/css/esri.css'>
  <link rel="stylesheet" href="css/style.css">
  <style>
  html, body{
		padding: 0;
		margin: 0;
		height: 100%;
		width: 100%;
  }
  #viewDiv { height: calc(100% - 300px); width: 100%; }
  #chart1, #chart2 { height: 300px; width: 33%; box-shadow: 0px 0px 0px 1px black inset; float: left;}
  #chart3 { height: 300px; width: 34%; box-shadow: 0px 0px 0px 1px black inset; float: right;}
  </style>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.21.12/amcharts.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.21.12/serial.js'></script>
  <script src='https://unpkg.com/@esri/cedar@1.0.0-beta.2/dist/umd/cedar.js'></script>
  <script src='https://unpkg.com/@esri/cedar@1.0.0-beta.2/dist/umd/themes/amCharts/calcite.js'></script>
  <script src='https://js.arcgis.com/3.23/'></script>
  
  <script>
	require(["esri/map", 
	  "esri/layers/FeatureLayer", 
	  "dojo/domReady!"
	], function(Map, FeatureLayer) {

	  var map = new Map("viewDiv", {
	    center: [-99, 38.9],
		zoom: 4,
		basemap: "topo"
	  });
		  
	  var featureLayer = new FeatureLayer("https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_States_Generalized/FeatureServer/0",
		{ outFields: ["*"] }
	  );

	  map.addLayer(featureLayer);
	  featureLayer.on("update-end", function(response) {
	    var features = [];

	    response.target.graphics.forEach(feature => {
		  features.push({
		    attributes: {
			  STATE_ABBR: feature.attributes.STATE_ABBR,
			  POPULATION: feature.attributes.POPULATION,
			  POP_SQMI: feature.attributes.POP_SQMI,
			  MED_AGE: feature.attributes.MED_AGE
		    }
		  });
		});
			
		loadCharts(features, "chart1", "POPULATION", "Population")
		loadCharts(features, "chart2", "POP_SQMI", "Density (Square Mile)")
		loadCharts(features, "chart3", "MED_AGE", "Median Age")
			
	  });
		  
	  function loadCharts(features, chartName, chartField, chartLabel){
	    features.sort(function(a, b) {
		  return b.attributes.POPULATION -a.attributes.POPULATION;
		});
		var definition = {
		  type: "bar",
		  datasets: [{
		    data: {
			  features: features
			}
		  }],
		  series: [{
		    category: {
		      field: "STATE_ABBR",
			  label: "US State"
		    },
		    value: {
		      field: chartField,
			  label: chartLabel
		   }
		  }]
		};
		var cedarChart = new cedar.Chart(chartName, definition);
		  cedarChart.show();
		}
		  
		});

  </script>
  
</head>

<body>

<div id="viewDiv"></div>
<div id="chart1"></div>
<div id="chart2"></div> 
<div id="chart3"></div> 

</body>
</html>
